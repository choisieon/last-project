{% extends "base.html" %}
{% load static %}

{% block title %}글쓰기 | 청설모{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/tagify.css' %}">
<script src="{% static 'js/tagify.min.js' %}"></script>
<script src="{% static 'tinymce/js/tinymce/tinymce.min.js' %}"></script>
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}

{% block content %}
<div class="form-outer">
  <div class="form-container">
    <h2>✏️ 새 글 작성</h2>
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}

      <!-- 제목 -->
      <div class="form-group">
        {{ form.title.label_tag }}
        {{ form.title }}
        {% for error in form.title.errors %}
        <div class="error">{{ error }}</div>
        {% endfor %}
      </div>

      <!-- 카테고리 -->
      <div class="form-group">
        {{ form.category.label_tag }}
        {{ form.category }}
        {% for error in form.category.errors %}
        <div class="error">{{ error }}</div>
        {% endfor %}
      </div>

      <!-- 후기 전용 썸네일 -->
      <div class="form-group" id="thumbnail-field" style="display:none;">
        {{ form.thumbnail.label_tag }}
        {{ form.thumbnail }}
        <div style="color:#888; font-size:0.97em; margin-top:6px;">
          후기글 대표 썸네일로 사용됩니다. (필수)
        </div>
        {% for error in form.thumbnail.errors %}
        <div class="error">{{ error }}</div>
        {% endfor %}
      </div>

      <!-- 자료공유/잡담 전용 이미지 -->
      <div class="form-group" id="image-field">
        {{ form.images.label_tag }}
        {{ form.images }}
      </div>

      <!-- 본문 -->
      <div class="form-group">
        {{ form.content.label_tag }}
        <div id="content_field">
          {{ form.content }}
        </div>
      </div>

      <!-- 태그 입력란 -->
      <div class="form-group">
        <label for="id_tags">태그 (쉼표로 구분):</label>
        <input name="tags" id="id_tags" value="">
        {% for error in form.tags.errors %}
        <div class="error">{{ error }}</div>
        {% endfor %}
        <div style="margin-top:8px;">
          <span style="color:#888; font-size:0.96em;">추천 태그:</span>
          {% for tag in popular_tags %}
          <button type="button" class="tag-suggest-btn" style="margin:2px 4px; padding:2px 8px; border-radius:10px; border:1px solid #1976d2; background:#f0f4fa; color:#1976d2; cursor:pointer;" onclick="addTag('{{ tag.name }}')">#{{ tag.name }}</button>
          {% endfor %}
        </div>
      </div>

      <button type="submit" class="write-btn">등록</button>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const categorySelect = document.getElementById('id_category');
  let tinymceLoaded = false;

  function enableTinyMCE() {
  if (tinymceLoaded) return;
  document.getElementById('id_content').removeAttribute('required');
  tinymce.init({
    selector: 'textarea#id_content',
    height: 600,
    language: 'ko_KR',
    language_url: '/static/tinymce/js/langs/ko_KR.js',
    plugins: 'advlist autolink lists link image charmap print preview hr anchor pagebreak searchreplace wordcount visualblocks visualchars code fullscreen insertdatetime media nonbreaking save table contextmenu directionality emoticons template paste textcolor colorpicker textpattern codesample',
    toolbar: 'fullscreen preview bold italic underline | fontselect fontsizeselect | forecolor backcolor | alignleft alignright aligncenter alignjustify | indent outdent | bullist numlist table | link image media | codesample | visualblocks visualchars | charmap emoticons | insertdatetime | hr nonbreaking | template | pagebreak restoredraft | code',
    contextmenu: 'formats | link image',
    menubar: 'file edit view insert format tools table help',
    content_css: 'writer',
    content_style: `
    img {
      display: inline-block;
      margin: 0 8px 8px 0;
      max-width: 32%;
      height: auto;
      vertical-align: middle;
    }
    /* 여러 이미지가 한 줄에 들어갈 때 줄바꿈 방지 */
    p, div {
      overflow: hidden;
    }
    /* float 스타일이 들어간 경우에도 튐 방지 */
    img[style*="float: left"] {
      float: left;
      margin-right: 12px;
      margin-bottom: 8px;
    }
    img[style*="float: right"] {
      float: right;
      margin-left: 12px;
      margin-bottom: 8px;
    }
    /* 이미지를 감싸는 요소에 clear 적용 */
    p:after, div:after {
      content: "";
      display: block;
      clear: both;
    }
  `,
    setup: function(editor) {
      editor.on('init', function() {
        if (editor.getContent() === '') {
          editor.setContent(
            '<p style="background:#fffbe9; border:1.5px dashed #fbc02d; padding:8px 14px; border-radius:7px; color:#b8860b; margin-bottom:16px;">' +
              '※ <strong>대표 썸네일 이미지는 위에서 반드시 첨부</strong>해 주세요.<br>' +
              '본문에는 추가 사진, 자료, 링크 등을 자유롭게 삽입할 수 있습니다.' +
            '</p>' +
            '<h3>1. 경험한 일</h3>' +
            '<p>구체적으로 어떤 상황/사건이었는지 적어주세요.</p>' +
            '<hr>' +
            '<h3>2. 느낀 점</h3>' +
            '<p>당시 느꼈던 감정, 생각, 배운 점 등을 자유롭게 작성해 주세요.</p>' +
            '<hr>' +
            '<h3>3. 추천/비추천 이유</h3>' +
            '<p>이 경험을 다른 사람에게 추천하거나 비추천하는 이유를 적어주세요.</p>' +
            '<hr>' +
            '<h3>추가 정보 (선택)</h3>' +
            '<p>사진, 링크, 참고자료 등 추가적으로 공유하고 싶은 내용이 있다면 첨부해 주세요.</p>'
          );
        }
      });
    },
    // ✅ 핸들러는 반드시 tinymce.init 옵션 객체 내부에
    images_upload_handler: function (blobInfo) {
      return new Promise((resolve, reject) => {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/board/upload-image/');
        xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
        xhr.upload.onprogress = function (e) {
          // progress 표시 필요 시 구현
        };
        xhr.onload = function() {
          if (xhr.status === 403) {
            reject({ message: 'HTTP Error: ' + xhr.status, remove: true });
            return;
          }
          if (xhr.status < 200 || xhr.status >= 300) {
            reject('HTTP Error: ' + xhr.status);
            return;
          }
          var json = JSON.parse(xhr.responseText);
          if (!json || typeof json.location != 'string') {
            reject('Invalid JSON: ' + xhr.responseText);
            return;
          }
          resolve(json.location); // 성공 시 resolve
        };
        xhr.onerror = function () {
          reject('Image upload failed due to a XHR Transport error. Code: ' + xhr.status);
        };
        var formData = new FormData();
        formData.append('file', blobInfo.blob(), blobInfo.filename());
        xhr.send(formData);
      });
    }
  }); // ✅ tinymce.init 옵션 객체 닫기

  tinymceLoaded = true; // (선택사항: 전역 변수 선언 필요)
}


  function disableTinyMCE() {
    if (!tinymceLoaded) return;
    tinymce.remove('#id_content');
    tinymceLoaded = false;
  }

  categorySelect.addEventListener('change', function() {
    const isReview = this.value === 'review';
    document.getElementById('thumbnail-field').style.display = isReview ? 'block' : 'none';
    document.getElementById('image-field').style.display = isReview ? 'none' : 'block';
    if (isReview) {
      enableTinyMCE();
    } else {
      disableTinyMCE();
      if (tinymce.get('id_content')) {
        tinymce.get('id_content').setContent('');
      }
      document.getElementById('id_content').value = '';
    }
  });

  // 페이지 로드 시 초기 상태 반영
  if (categorySelect.value === 'review') {
    enableTinyMCE();
    document.getElementById('thumbnail-field').style.display = 'block';
    document.getElementById('image-field').style.display = 'none';
  } else {
    document.getElementById('thumbnail-field').style.display = 'none';
    document.getElementById('image-field').style.display = 'block';
  }

  document.querySelector('form').addEventListener('submit', function() {
    tinymce.triggerSave();
  });

  // Tagify 적용
  var input = document.querySelector('input[name=tags]');
  window.tagify = new Tagify(input, {
    whitelist: [{% for tag in popular_tags %}"{{ tag.name }}"{% if not forloop.last %},{% endif %}{% endfor %}],
    pattern: /^[가-힣a-zA-Z0-9:_-]{2,10}$/,
    editTags: false,
    dropdown: {
      enabled: 0,
      closeOnSelect: false,
      maxItems: 100,
      classname: "tagify__inline__suggestions"
    }
  });

  // 추천 태그 버튼 클릭 시 태그 추가
  window.addTag = function(tagName) {
    window.tagify.addTags([tagName]);
  };
});
</script>
{% endblock %}

{% block extra_style %}
<style>
.form-outer {
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
  padding-top: 40px;
}

.form-container {
  width: 480px;
  background: rgba(255,255,255,0.95);
  border: 2.5px solid #5a4a2f;
  box-shadow: 4px 4px 0 #b9a782;
  border-radius: 14px;
  padding: 36px 32px 28px 32px;
}

.form-group {
  margin-bottom: 22px;
}

.form-group label {
  display: block;
  color: #222;
  font-weight: bold;
  font-size: 1.12rem;
  margin-bottom: 7px;
  text-shadow: 1px 1px 3px #fff, 0 0 2px #0008;
}

.form-control {
  width: 100%;
  border: 2px solid #1976d2;
  border-radius: 7px;
  padding: 13px 14px;
  font-size: 1.09rem;
  background: #fffbe9;
  color: #222831;
  box-shadow: 2px 2px 0 #b9a78233;
  margin-bottom: 13px;
}

.form-control:focus {
  border: 2px solid #007aff;
  background: #fff;
  outline: none;
  box-shadow: 0 0 8px #007aff33;
}

.write-btn {
  background-color: #007aff;
  color: white;
  padding: 6px 12px;
  border: none;
  cursor: pointer;
  font-weight: bold;
  font-size: 14px;
  border: 2px solid #5a4a2f;
  box-shadow: 3px 3px 0 #b9a782;
}

.write-btn:hover {
  background: #005bb5;
  color: #fff700;
}

.error {
  color: #d32f2f;
  font-size: 0.97rem;
  margin-top: 2px;
  margin-bottom: 4px;
}

.tox-tinymce {
  border-radius: 8px;
  margin-top: 10px;
}
</style>
{% endblock %}
