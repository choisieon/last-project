{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="form-outer">
  <div class="form-container">
    <h2>글쓰기</h2>
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="form-group">
        {{ form.title.label_tag }}
        {{ form.title }}
        {% for error in form.title.errors %}
          <div class="error">{{ error }}</div>
        {% endfor %}
      </div>
      <div class="form-group">
        {{ form.category.label_tag }}
        {{ form.category }}
        {% for error in form.category.errors %}
          <div class="error">{{ error }}</div>
        {% endfor %}
      </div>
      <div class="form-group">
        {{ form.content.label_tag }}
        <div id="content_field">
          {{ form.content }}
        </div>
      </div>
      <div class="form-group" id="image_field">
        {{ form.images.label_tag }}
        {{ form.images }}
      </div>
      <button type="submit" class="write-btn">등록</button>
    </form>
  </div>
</div>

<!-- Self-hosted TinyMCE 스크립트 -->
<script src="{% static 'tinymce/js/tinymce/tinymce.min.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const categorySelect = document.getElementById('id_category');
  let tinymceLoaded = false;

  function enableTinyMCE() {
    if (tinymceLoaded) return;
    document.getElementById('id_content').removeAttribute('required');
    tinymce.init({
      selector: 'textarea#id_content',
      height: 500,
      language: 'ko_KR',
      plugins: 'advlist autolink lists link image charmap preview anchor searchreplace visualblocks code fullscreen insertdatetime media table help wordcount',
      toolbar: 'undo redo | formatselect | bold italic backcolor | \
                alignleft aligncenter alignright alignjustify | \
                bullist numlist outdent indent | removeformat | help | \
                link image media code preview fullscreen',
      menubar: 'file edit view insert format tools table help',
      content_css: 'writer',
      images_upload_url: '/board/upload-image/',
      automatic_uploads: true,
      setup: function(editor) {
        editor.on('init', function() {
          if (editor.getContent() === '') {
            editor.setContent(
              '<h3>1. 경험한 일</h3>' +
              '<p>여기에 자신이 겪은 상황이나 사건을 구체적으로 적어주세요.</p>' +
              '<p style="color:#888; font-size:0.95em;">예시: "처음에는 두려웠지만, 직접 해보니 생각보다 쉬웠습니다."</p>' +
              '<hr>' +
              '<h3>2. 느낀 점</h3>' +
              '<p>당시 느꼈던 감정, 생각, 배운 점 등을 자유롭게 작성해 주세요.</p>' +
              '<hr>' +
              '<h3>3. 추천/비추천 이유</h3>' +
              '<p>이 경험을 다른 사람에게 추천하거나 비추천하는 이유를 적어주세요.</p>' +
              '<hr>' +
              '<h3>추가 정보 (선택)</h3>' +
              '<p>사진, 링크, 참고자료 등 추가적으로 공유하고 싶은 내용이 있다면 첨부해 주세요.</p>'
            );
          }
        });
      }
    });
    tinymceLoaded = true;
}

  function disableTinyMCE() {
    if (!tinymceLoaded) return;
    tinymce.remove('#id_content');
    tinymceLoaded = false;
  }

  categorySelect.addEventListener('change', function() {
    if (this.value === 'review') {
      enableTinyMCE();
      document.getElementById('image_field').style.display = 'none';
    } else {
      disableTinyMCE();
      document.getElementById('image_field').style.display = 'block';
      if (tinymce.get('id_content')) {
        tinymce.get('id_content').setContent('');
      }
      document.getElementById('id_content').value = '';
    }
  });


  // 페이지 로드 시 초기 상태 반영
  if (categorySelect.value === 'review') {
    enableTinyMCE();
    document.getElementById('image_field').style.display = 'none';
  }
  document.querySelector('form').addEventListener('submit', function() {
    tinymce.triggerSave();
  });
});
</script>
{% endblock %}

{% block extra_style %}
<style>
.form-outer {
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
  padding-top: 40px;
}

.form-container {
  width: 480px;
  background: rgba(255,255,255,0.95);
  border: 2.5px solid #5a4a2f;
  box-shadow: 4px 4px 0 #b9a782;
  border-radius: 14px;
  padding: 36px 32px 28px 32px;
}

.form-group {
  margin-bottom: 22px;
}

.form-group label {
  display: block;
  color: #222;
  font-weight: bold;
  font-size: 1.12rem;
  margin-bottom: 7px;
  text-shadow: 1px 1px 3px #fff, 0 0 2px #0008;
}

.form-control {
  width: 100%;
  border: 2px solid #1976d2;
  border-radius: 7px;
  padding: 13px 14px;
  font-size: 1.09rem;
  background: #fffbe9;
  color: #222831;
  box-shadow: 2px 2px 0 #b9a78233;
  margin-bottom: 13px;
}

.form-control:focus {
  border: 2px solid #007aff;
  background: #fff;
  outline: none;
  box-shadow: 0 0 8px #007aff33;
}

.write-btn {
  background-color: #007aff;
    color: white;
    padding: 6px 12px;
    border: none;
    cursor: pointer;
    font-weight: bold;
    font-size: 14px;
    border: 2px solid #5a4a2f;
    box-shadow: 3px 3px 0 #b9a782;
}

.write-btn:hover {
  background: #005bb5;
  color: #fff700;
}

.error {
  color: #d32f2f;
  font-size: 0.97rem;
  margin-top: 2px;
  margin-bottom: 4px;
}
</style>
{% endblock %}
