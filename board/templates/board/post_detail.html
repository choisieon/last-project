
{% extends "base.html" %}
{% load static %}

{% block title %}{{ post.title }} | 청설모{% endblock %}
{% block nav_community_active %}active{% endblock %}

{% block content %}
<div class="post-detail">
  <div class="post-item">
    <h4>{{ post.title }}</h4>
    <div class="post-meta">
      <span>작성자: {{ post.author }}</span>
      <span>|</span>
      <span>작성일: {{ post.created_at|date:"Y-m-d H:i" }}</span>
      <span>|</span>
      <span>조회수: {{ post.views }}</span>
      <span>|</span>
      <span class="like-group">
        <a href="#" class="like-btn" data-post-id="{{ post.pk }}">
          <span class="like-icon">
            {% if request.user in post.likes.all %}❤️{% else %}🤍{% endif %}
          </span>
          <span class="like-count">{{ post.likes.count }}</span>
        </a>
      </span>
    </div>
    {% if post.images.all %}
      <div class="post-images" style="margin-bottom:1rem;">
        {% for image in post.images.all %}
          <img src="{{ image.image.url }}" alt="첨부 이미지" style="max-width:350px; max-height:350px; width:100%; height:auto; border-radius:8px; margin-bottom:8px; display:block;">
        {% endfor %}
      </div>
    {% endif %}
    <div class="post-content">
      {{ post.content|safe }}
    </div>
    <div class="post-actions">
      <a href="{% url 'board:post_list' %}{% if request.GET.category or request.GET.sort or request.GET.keyword %}?{% endif %}
{% if request.GET.category %}category={{ request.GET.category }}{% endif %}
{% if request.GET.sort %}{% if request.GET.category %}&{% endif %}sort={{ request.GET.sort }}{% endif %}
{% if request.GET.keyword %}{% if request.GET.category or request.GET.sort %}&{% endif %}keyword={{ request.GET.keyword }}{% endif %}">목록으로</a>
      {% if request.user == post.author %}
        <a href="{% url 'board:post_edit' post.pk %}" style="margin-left:10px; color:#007aff; border-color:#007aff;">수정</a>
        <form action="{% url 'board:post_delete' post.pk %}" method="post" style="display:inline; margin-left:10px;">
          {% csrf_token %}
          <button type="submit"
                  onclick="return confirm('정말 삭제하시겠습니까?');"
                  style="background:none;
                         border:1.5px solid #dc3545;
                         color:#dc3545;
                         padding:6px 12px;
                         border-radius:4px;
                         cursor:pointer;">
            삭제
          </button>
        </form>
      {% endif %}
    </div>
  </div>

  <!-- 댓글 입력 폼 (최상위 댓글) -->
  <div class="comment-form">
    <form method="post">
      {% csrf_token %}
      {{ comment_form.content }}
      <input type="hidden" name="parent_id" value="">
      <button type="submit" class="write-btn">댓글 작성</button>
    </form>
  </div>

  <!-- 댓글/대댓글 목록 -->
  <div class="comment-list">
    {% for comment in comments %}
      <div class="comment" id="comment-{{ comment.id }}">
        <strong>{{ comment.author }}</strong>
        <span>{{ comment.created_at|date:"Y-m-d H:i" }}</span>
        <p>{{ comment.content }}</p>
        <!-- 답글 버튼 -->
        <a href="#" class="reply-toggle" data-comment-id="{{ comment.id }}">답글</a>
        <!-- 대댓글 작성 폼 (처음엔 숨김) -->
        <form method="post" class="comment-form reply-form" data-parent-id="{{ comment.id }}" style="display:none;">
          {% csrf_token %}
          {{ comment_form.content }}
          <input type="hidden" name="parent_id" value="{{ comment.id }}">
          <button type="submit">대댓글 작성</button>
        </form>
        <!-- 대댓글(재귀 출력) -->
        {% include "board/comment_replies.html" with replies=comment.replies.all comment_form=comment_form %}
      </div>
    {% empty %}
      <div class="comment-empty">아직 댓글이 없습니다.</div>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block extra_style %}
<style>
  .post-detail .post-item {
    padding: 20px;
    margin-top: 20px;
    background: rgba(250,235,180,0.93);
    background-image: url("{% static 'images/pixel-paper.png' %}");
    background-size: 4px 4px;
    border: 2px solid #5a4a2f;
    box-shadow: 2px 2px 0 #b9a782;
    border-radius: 8px;
  }
  .post-detail h4 {
    font-size: 1.4rem;
    color: #1976d2;
    font-weight: bold;
    margin-bottom: 10px;
  }
  .post-meta {
    margin-bottom: 15px;
    font-size: 1.05rem;
    color: #4a3b28;
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    line-height: 1.6;
  }
  .like-group {
    display: flex;
    align-items: center;
    gap: 3px;
  }
  .like-btn {
    display: flex;
    align-items: center;
    gap: 2px;
    text-decoration: none;
    font-weight: bold;
    color: #e53935;
    font-size: 1.05rem;
    transition: color 0.2s;
    padding: 0 2px;
    border-radius: 4px;
    background: none;
    cursor: pointer;
  }
  .like-btn:hover {
    color: #1976d2;
    background: #fffbe6;
  }
  .like-icon {
    font-size: 1.1em;
    line-height: 1;
    display: inline-flex;
    align-items: center;
    vertical-align: middle;
  }
  .like-count {
    font-size: 1em;
    color: #e53935;
    line-height: 1;
    display: inline-flex;
    align-items: center;
    vertical-align: middle;
    font-weight: bold;
    margin-left: 1px;
  }
  .post-content {
    margin: 15px 0;
    font-size: 1.07rem;
    line-height: 1.7;
    color: #222831;
  }
  .post-actions {
    margin-top: 20px;
    text-align: right;
  }
  .post-actions a {
    color: #007aff;
    font-weight: bold;
    text-decoration: none;
    padding: 6px 12px;
    border-radius: 4px;
    border: 1.5px solid #007aff;
    background: #fff;
    transition: background 0.2s, color 0.2s;
  }
  .post-actions a:hover {
    background: #007aff;
    color: #fff;
  }
  .post-actions form button:hover {
    background: #dc3545;
    color: white;
  }
  .comment-form {
    margin: 30px 0 18px 0;
    background: rgba(250,235,180,0.92);
    border: 1.5px solid #5a4a2f;
    border-radius: 6px;
    padding: 18px 16px;
  }
  .comment-form textarea,
  .comment-form input[type="text"] {
    width: 100%;
    padding: 10px;
    border: 1.5px solid #5a4a2f;
    background: #fff;
    font-size: 1rem;
    border-radius: 4px;
    margin-bottom: 10px;
    box-sizing: border-box;
  }
  .comment-form .write-btn {
    background: #007aff;
    color: #fff;
    border: 1.5px solid #5a4a2f;
    border-radius: 4px;
    padding: 8px 20px;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.2s;
  }
  .comment-form .write-btn:hover {
    background: #005bb5;
  }
  .comment-list {
    margin: 0 0 10px 0;
    padding: 0;
  }
  .comment {
    background: #fffbe6;
    border: 1px solid #e9c46a;
    border-radius: 4px;
    padding: 10px 12px;
    margin-bottom: 10px;
  }
  .comment strong {
    color: #1976d2;
    font-weight: bold;
    margin-right: 8px;
  }
  .comment span {
    color: #888;
    font-size: 0.95rem;
    margin-left: 4px;
  }
  .comment-empty {
    color: #aaa;
    text-align: center;
    margin: 20px 0;
    font-size: 1rem;
  }
</style>
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', function() {
  const likeBtn = document.querySelector('.like-btn');
  if (likeBtn) {
    likeBtn.addEventListener('click', function(e) {
      e.preventDefault();
      const postId = likeBtn.getAttribute('data-post-id');
      fetch(`/board/post/${postId}/like_ajax/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json',
        },
        credentials: 'same-origin',
      })
      .then(response => {
        if (!response.ok) throw new Error('서버 오류');
        return response.json();
      })
      .then(data => {
        const likeIcon = likeBtn.querySelector('.like-icon');
        const likeCount = likeBtn.querySelector('.like-count');
        likeIcon.textContent = data.liked ? '❤️' : '🤍';
        likeCount.textContent = data.count;
      })
      .catch(err => {
        alert('로그인이 필요하거나 오류가 발생했습니다.');
      });
    });
  }

  // 대댓글 폼 토글
  document.querySelectorAll('.reply-toggle').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const commentId = this.dataset.commentId;
      const form = document.querySelector('.reply-form[data-parent-id="' + commentId + '"]');
      if (form) {
        form.style.display = (form.style.display === 'none' || form.style.display === '') ? 'block' : 'none';
      }
    });
  });
});
</script>
{% endblock %}

