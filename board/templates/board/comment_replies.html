{% for reply in replies %}
  <div class="comment reply" 
       style="margin-left: {% if reply.parent.parent %}0{% else %}2rem{% endif %};" 
       id="comment-{{ reply.id }}">
    
    {% if not reply.is_blinded %}
      {# ë‹µê¸€ ëŒ€ìƒ í‘œì‹œ (3ë‹¨ê³„ ì´ìƒ) #}
      {% if reply.parent.parent %}
        <span style="color:#888; font-size:0.95em;">â†³ {{ reply.parent.author }}ë‹˜ì—ê²Œ ë‹µê¸€</span>
      {% endif %}

      {# ëŒ“ê¸€ ì •ë³´ #}
      <strong>{{ reply.author }}</strong>
      <span>{{ reply.created_at|date:"Y-m-d H:i" }}</span>
      <p>{{ reply.content }}</p>

      {# ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ (ì‘ì„±ìë§Œ ë³´ì„) #}
      {% if user == reply.author %}
        <a href="{% url 'board:comment_edit' reply.pk %}" class="edit-btn">ìˆ˜ì •</a>
        <form action="{% url 'board:comment_delete' reply.pk %}" method="post" style="display:inline;">
          {% csrf_token %}
          <button type="submit" 
                  class="delete-btn"
                  onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
            ì‚­ì œ
          </button>
        </form>
      {% endif %}

      {# ëŒ“ê¸€/ëŒ€ëŒ“ê¸€ ì‹ ê³  ë²„íŠ¼ (ì‘ì„±ì ë³¸ì¸ ì œì™¸, ë¹„ë™ê¸°) #}
      {% if user.is_authenticated and user != reply.author %}
        <button type="button"
                class="comment-report-btn"
                data-comment-id="{{ reply.id }}"
                style="margin-left:10px; color:#e53935; border:1px solid #e53935; padding:3px 10px; border-radius:4px; background:#fff7f7; font-size:0.97em; font-weight:bold; cursor:pointer;">
          ğŸš¨ ì‹ ê³ 
        </button>
        <span id="comment-report-count-{{ reply.id }}" style="color:#e53935; font-size:0.95em; margin-left:4px;">
          {% if reply.report_count %}ì‹ ê³  {{ reply.report_count }}íšŒ{% endif %}
        </span>
      {% endif %}

      {# ë‹µê¸€ ë²„íŠ¼ & ëŒ€ëŒ“ê¸€ í¼ #}
      <a href="#" class="reply-toggle" data-comment-id="{{ reply.id }}">ë‹µê¸€</a>
      <form method="post" 
            class="comment-form reply-form" 
            data-parent-id="{{ reply.id }}" 
            style="display:none;">
        {% csrf_token %}
        {{ comment_form.content }}
        <input type="hidden" name="parent_id" value="{{ reply.id }}">
        <button type="submit" class="write-btn">ëŒ€ëŒ“ê¸€ ì‘ì„±</button>
      </form>
    {% else %}
      <div class="blinded-comment" style="color:#e53935; background:#fff7f7; padding:6px 12px; border-radius:4px; font-size:0.96em;">
        ğŸš« ë¸”ë¼ì¸ë“œ ì²˜ë¦¬ëœ ëŒ“ê¸€ì…ë‹ˆë‹¤
      </div>
    {% endif %}

    {% include "board/comment_replies.html" with replies=reply.replies.all comment_form=comment_form %}
  </div>
{% endfor %}

<!-- ğŸš¨ ì‹ ê³  ëª¨ë‹¬ (í˜ì´ì§€ ë‚´ í•œ ë²ˆë§Œ!) -->
<div id="report-modal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:9999;">
  <div style="background:#fff; padding:24px; border-radius:8px; max-width:350px; margin:120px auto; position:relative; box-shadow:0 4px 24px rgba(0,0,0,0.13);">
    <label for="report-reason" style="font-weight:bold; display:block; margin-bottom:8px;">ì‹ ê³  ì‚¬ìœ ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”:</label>
    <textarea id="report-reason" rows="4" maxlength="200" style="width:100%; margin-bottom:8px; padding:6px; resize:vertical;"></textarea>
    <div style="font-size:0.95em; color:#888; margin-bottom:10px;">
      (ìµœëŒ€ 200ì, Enterë¡œ ì œì¶œ / Shift+Enter ì¤„ë°”ê¿ˆ / ESCë¡œ ë‹«ê¸°)
    </div>
    <div style="text-align:right;">
      <button id="report-submit" style="margin-right:8px;">ì‹ ê³ </button>
      <button id="report-cancel">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  let isReporting = false;
  let currentCommentId = null;
  const modal = document.getElementById('report-modal');
  const reasonInput = document.getElementById('report-reason');
  const submitBtn = document.getElementById('report-submit');
  const cancelBtn = document.getElementById('report-cancel');
  const MAX_LENGTH = 200;

  // ì‹ ê³  ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ ì˜¤í”ˆ
  document.querySelectorAll('.comment-report-btn').forEach(function(btn) {
    btn.addEventListener('click', function(event) {
      event.preventDefault();
      if (isReporting) return;
      currentCommentId = this.dataset.commentId;
      reasonInput.value = '';
      modal.style.display = 'block';
      reasonInput.focus();
    });
  });

  // ëª¨ë‹¬ ì·¨ì†Œ ë²„íŠ¼
  cancelBtn.onclick = function() {
    modal.style.display = 'none';
    currentCommentId = null;
  };

  // textareaì—ì„œ ì—”í„°(Submit) ë˜ëŠ” ESC(ë‹«ê¸°) ì²˜ë¦¬
  reasonInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      submitBtn.click();
    }
    if (e.key === 'Escape') {
      e.preventDefault();
      cancelBtn.click();
    }
  });

  // ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      modal.style.display = 'none';
      currentCommentId = null;
    }
  });

  // ì‹ ê³  ë²„íŠ¼ í´ë¦­
  submitBtn.onclick = function() {
    if (isReporting) return;
    const reason = reasonInput.value.trim();
    if (!reason) {
      alert("ì‹ ê³  ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
      reasonInput.focus();
      return;
    }
    if (reason.length > MAX_LENGTH) {
      alert(`ì‹ ê³  ì‚¬ìœ ëŠ” ìµœëŒ€ ${MAX_LENGTH}ìê¹Œì§€ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
      reasonInput.focus();
      return;
    }
    isReporting = true;
    submitBtn.disabled = true;
    modal.style.display = 'none';

    fetch(`/board/comment/${currentCommentId}/report/`, {
      method: "POST",
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ reason: reason })
    })
    .then(response => {
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      return response.json();
    })
    .then(data => {
      if (data.success) {
        const countElement = document.getElementById(`comment-report-count-${currentCommentId}`);
        if (countElement) {
          countElement.innerText = `ì‹ ê³  ${data.report_count}íšŒ`;
          countElement.style.display = 'none';
          countElement.offsetHeight;
          countElement.style.display = '';
        }
        if (data.blinded) {
          alert("ì‹ ê³  ëˆ„ì ìœ¼ë¡œ ë¸”ë¼ì¸ë“œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
          location.reload();
        } else {
          alert("ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
      } else {
        alert(data.message || "ì‹ ê³  ì²˜ë¦¬ ì‹¤íŒ¨");
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert("ì‹ ê³  ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
    })
    .finally(() => {
      isReporting = false;
      submitBtn.disabled = false;
      currentCommentId = null;
    });
  };
});
</script>
