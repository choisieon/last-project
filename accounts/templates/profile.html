{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <meta charset="UTF-8" />
  <title>마이페이지 - 인생 보드게임</title>
  <style>
    @font-face {
      font-family: 'MyCustomFont';
      src: url("{% static 'fonts/픽셀.woff2' %}") format('woff2');
      font-weight: 400;
      font-style: normal;
    }

    body {
      margin: 0;
      padding: 20px;
      font-family: 'MyCustomFont', sans-serif;
      background: url("{% static 'images/Frame 13.png' %}") no-repeat center center fixed;
      background-size: 105%;
    }
    .write-btn {
      background-color: #007aff;
    }
    .write-btn:hover {
      background: #005bb5;
      color: #fff700;

    }
    .login-info {
      background-color: rgba(250, 235, 180, 0.9);
      background-image: url("{% static 'images/pixel-paper.png' %}");
      background-size: 4px 4px;
      background-repeat: repeat;
      padding: 6px 12px;
      border: 2.5px solid #5a4a2f;
      box-shadow: 3px 3px 0 #b9a782;
      font-size: 14px;
      color: #3c2e1e;
      font-weight: bold;
      display: flex;
      align-items: center;
    }

    h1 {
      text-align: center;
      color: #4e3b2b;
    }

    .main-wrapper {
      max-width: 1320px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

.top-section {
  display: flex;
  justify-content: space-between;
  gap: 24px;
  align-items: flex-start;
}
    .profile-box {
      background-color: #f3f3f3;
      border: 4px solid #444;
      border-radius: 8px;
      padding: 16px;
      box-shadow: inset 0 0 0 4px #c2a178;
      width: 750px;
      min-height: 150px;
      position: relative;
    }

    .profile-upper {
      display: flex;
    }

    .left-profile {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 160px;
    }

    .avatar-wrapper {
      border: 4px solid #444;
      background: white;
      padding: 4px;
      border-radius: 8px;
      margin-bottom: 6px;
      width: 140px;
      height: 140px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .avatar-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .nickname-box {
      margin-top: 4px;
      font-size: 16px;
      font-weight: bold;
      text-align: center;
      width: 140px;
      background: #bde0fe;
      border: 2px solid #444;
      border-radius: 4px;
      padding: 6px 0;
    }
    .custom-menu {
  position: absolute;
  background: white;
  border: 2px solid #444;
  padding: 8px;
  border-radius: 6px;
  box-shadow: 2px 2px 0 #aaa;
  z-index: 999;
}

    .right-profile {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      padding-left: 10px;
    }

    .action-buttons {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .action-buttons button {
      background-color: #ffc107;
      border: 3px solid #444;
      border-radius: 6px;
      font-family: 'MyCustomFont';
      padding: 6px 10px;
      font-weight: bold;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      min-width: 80px;
    }

    .info-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .info-row {
      display: flex;
    }

    .info-label {
      width: 70px;
      background-color: #444;
      color: white;
      padding: 6px;
      font-size: 13px;
      font-weight: bold;
      border-radius: 4px 0 0 4px;
    }

    .info-value {
      flex: 1;
      background: white;
      padding: 6px;
      font-size: 13px;
      border: 2px solid #444;
      border-left: none;
      border-radius: 0 4px 4px 0;
      display: flex;
      align-items: center;
    }

    .policy-box {
      background-color: #f3f3f3;
      border: 4px solid #444;
      border-radius: 8px;
      padding: 16px;
      box-shadow: inset 0 0 0 4px #c2a178;
      width: 700px;
      font-family: 'MyCustomFont';
      font-size: 13px;
    }
    .profile-box,
.policy-box,
.admin-extra-wrapper {
  flex: 1;
  max-width: 32%;
}

    .policy-box select,
    .policy-box button {
      background-color: #8ecae6;
      border: 2px solid #444;
      border-radius: 6px;
      padding: 5px 12px;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      font-family: 'MyCustomFont';
      margin-top: 10px;
    }
.admin-wrapper {
  display: flex;
  flex-direction: column;
  gap: 12px;
  width: 420px;
}
.admin-extra-wrapper {
  display: flex;
  flex-direction: column;
  gap: 20px;
  width: 420px;
}

.admin-box,
.extra-box {
  background-color: #f3f3f3;
  border: 4px solid #444;
  border-radius: 8px;
  padding: 16px;
  box-shadow: inset 0 0 0 4px #c2a178;
  font-family: 'MyCustomFont';
  font-size: 13px;
}

.profile-section {
  display: flex;
  flex-direction: column;
  flex: 1;
  max-width: 32%;
}

.edit-button-container {
  display: flex;
  justify-content: flex-end;
  margin-top: 4px;
}

.edit-button {
  background-color: #90e0ef;
  border: 3px solid #444;
  border-radius: 6px;
  padding: 6px 14px;
  font-size: 13px;
  font-family: 'MyCustomFont';
  font-weight: bold;
  cursor: pointer;
  box-shadow: 2px 2px 0 #444;
}
.title-box {
  background-color: #f3f3f3;
  border: 4px solid #444;
  box-shadow: inset 0 0 0 4px #c2a178;
  border-radius: 12px;
  padding: 20px 40px;
  width: fit-content;
  margin: 0 auto 24px auto; /* 가운데 정렬 + 아래 여백 */
  font-family: 'MyCustomFont';
}

.title-box h1 {
  margin: 0;
  font-size: 28px;
  text-align: center;
  color: #2f2f2f;
}
.section-title-box {
  position: absolute;
  top: -40px;
  left: 12px;
  background-color: #fffef9;
  border: 3px solid #444;
  box-shadow: inset 0 0 0 3px #c2a178;
  border-radius: 8px;
  padding: 10px 20px;
  width: fit-content;
  margin: 0 0 10px 24px;  /* 왼쪽 정렬 + 여백 (좌측 24px) */
  font-family: 'MyCustomFont';
}


.section-title-box h2 {
  margin: 0;
  font-size: 18px;
  text-align: center;
  color: #333;
}

.delete-button {
  background-color: #ff6b6b;
  color: white;
  border: 2px solid #444;
  font-family: 'MyCustomFont';
  font-size: 12px;
  padding: 4px 8px;
  border-radius: 4px;
  cursor: pointer;
}

    .board-section {
      border: 4px solid #444;
      padding: 16px;
      border-radius: 12px;
      background: url("{% static 'images/journey-bg.png' %}") repeat;
      background-size: contain;
      box-shadow: inset 0 0 0 4px #c2a178;
      width: 100%;
      margin-top: 20px;
      font-family: 'MyCustomFont';
      box-sizing: border-box;
      position: relative;
    }

.tile {
  width: 160px;
  background-color: #fff;
  border: 3px solid #444;
  border-radius: 10px;
  padding: 10px;
  font-family: 'MyCustomFont';
  font-size: 12px;
  position: relative;
  box-shadow: 2px 2px 0 #aaa;
  transition: transform 0.2s ease;
}

.tile:hover {
  transform: scale(1.03);
}

.tile-header {
  font-weight: bold;
  margin-bottom: 6px;
  background-color: #ffd6a5;
  padding: 4px;
  border-radius: 4px;
  text-align: center;
}


.tile-content {
  margin-bottom: 6px;
}

.tile-detail {
  font-size: 11px;
  color: #444;
  background: #f9f9f9;
  padding: 4px;
  border-radius: 4px;
  margin-top: 6px;
}

.journey-tile:hover {
  transform: scale(1.05);
}

.life-journey {
  position: relative;
}
.life-journey-line {
  position: absolute;
  top: 0;
  left: 0;
  pointer-events: none;
  z-index: 0;
}
.life-event {
  position: relative;
  z-index: 1;
}


.metrics {
  font-size: 11px;
  color: #555;
}

/* Base container styling */
.life-journey-wrapper {
  overflow-x: auto;           /* Enable horizontal scrolling if needed */
  overflow-y: hidden;
  padding: 10px;
  /* (optional) background-color or other styling */
}

/* Timeline inner container */
.life-journey {
  position: relative;
  display: flex;
  flex-wrap: nowrap;
  align-items: flex-start;    /* align items to top by default */
  width: max-content;        /* Expand width to accommodate all tiles (so scroll works) */
  min-height: 250px;         /* Enough height to accommodate wave amplitude */
  padding: 20px 0;
}

/* Individual event tile container */
.life-event {
  position: relative;        /* positioning context for tooltip */
  flex: 0 0 auto;            /* do not flex-grow, keep natural width */
  margin-right: 60px;        /* spacing between tiles */
}

/* Tile styling with pixel-art style border */
.life-event-tile {
  background: 
    radial-gradient(circle at 2px 2px, rgba(255,255,255,0.7) 1px, transparent 0),
    radial-gradient(circle at 6px 6px, rgba(255,255,255,0.5) 1px, transparent 0),
    radial-gradient(circle at 10px 10px, rgba(255,255,255,0.3) 1px, transparent 0);
  background-size: 8px 8px, 12px 12px, 16px 16px;
  background-color: #fff8dc;
  color: #2c1810;
  padding: 12px;
  width: 160px;
  min-height: 100px;
  border: 3px solid #2c1810;
  box-shadow: 
    3px 3px 0 #8b7355,
    inset 2px 2px 0 rgba(255,255,255,0.4),
    inset -1px -1px 0 rgba(0,0,0,0.2);
  position: relative;
  transition: transform 0.1s ease;
}

.life-event-tile:hover {
  transform: translate(-1px, -1px);
  box-shadow: 
    4px 4px 0 #8b7355,
    inset 2px 2px 0 rgba(255,255,255,0.3),
    inset -1px -1px 0 rgba(0,0,0,0.1);
}

.life-event-title {
  margin: 0 0 6px;
  font-size: 1.1em;
  text-align: center;
  font-weight: bold;
  color: #2c1810;
  text-shadow: 1px 1px 0 rgba(255,255,255,0.5);
}

.life-event-date {
  font-size: 0.9em;
  display: block;
  text-align: center;
  color: #2c1810;
  font-weight: bold;
  background: rgba(255,255,255,0.6);
  padding: 2px 6px;
  border-radius: 8px;
  margin-bottom: 8px;
  border: 1px solid rgba(0,0,0,0.2);
  box-shadow: inset 1px 1px 0 rgba(255,255,255,0.8);
}

.event-scores {
  margin-top: 6px;
  display: flex;
  flex-direction: column;
  gap: 3px;
}

.score-item {
  display: flex;
  align-items: center;
  gap: 4px;
}

.score-label {
  font-size: 10px;
  font-weight: bold;
  min-width: 32px;
  font-family: 'MyCustomFont';
  text-shadow: 1px 1px 0 rgba(255,255,255,0.5);
}

.score-bar {
  flex: 1;
  height: 12px;
  background: 
    linear-gradient(90deg, transparent 50%, rgba(0,0,0,0.1) 50%),
    linear-gradient(0deg, transparent 50%, rgba(0,0,0,0.1) 50%);
  background-size: 4px 4px;
  background-color: #e8dcc0;
  border: 2px solid #2c1810;
  box-shadow: inset 1px 1px 0 rgba(0,0,0,0.2);
  position: relative;
  overflow: hidden;
}

.score-fill {
  height: 100%;
  transition: width 0.3s ease;
  position: relative;
}

.score-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: 
    linear-gradient(90deg, transparent 50%, rgba(255,255,255,0.1) 50%),
    linear-gradient(0deg, transparent 50%, rgba(255,255,255,0.1) 50%);
  background-size: 2px 2px;
}

.happiness-bar .score-fill {
  background: linear-gradient(135deg, #ff6b6b 0%, #e74c3c 50%, #c0392b 100%);
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.3);
}

.achievement-bar .score-fill {
  background: linear-gradient(135deg, #74b9ff 0%, #0984e3 50%, #2d3436 100%);
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.3);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 8px;
  font-weight: bold;
  color: #fff;
  text-shadow: 
    1px 1px 0 rgba(0,0,0,0.8),
    -1px -1px 0 rgba(0,0,0,0.8),
    1px -1px 0 rgba(0,0,0,0.8),
    -1px 1px 0 rgba(0,0,0,0.8);
  font-family: 'MyCustomFont';
}

/* Position the tiles in a repeating wave (top, mid, bottom, mid, ...) */
.life-event:nth-child(4n+1) { margin-top: 0; }
.life-event:nth-child(4n+2) { margin-top: 80px; }
.life-event:nth-child(4n+3) { margin-top: 160px; }
.life-event:nth-child(4n+4) { margin-top: 80px; }

/* 모달 오버레이 */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  z-index: 1000;
}

/* 이벤트 세부정보 모달 */
.event-detail-modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: 
    radial-gradient(circle at 2px 2px, rgba(255,255,255,0.8) 1px, transparent 0),
    radial-gradient(circle at 6px 6px, rgba(255,255,0,0.3) 1px, transparent 0),
    radial-gradient(circle at 10px 10px, rgba(255,255,255,0.6) 1px, transparent 0);
  background-size: 8px 8px, 12px 12px, 16px 16px;
  background-color: rgba(255, 255, 200, 0.95);
  border: 4px solid #5a4a2f;
  box-shadow: 6px 6px 0 #b9a782;
  border-radius: 0;
  padding: 20px;
  min-width: 400px;
  max-width: 700px;
  max-height: 80vh;
  overflow-y: auto;
  font-family: 'MyCustomFont';
  display: none;
  z-index: 1001;
}

.event-detail-modal h3 {
  margin: 0 0 10px 0;
  color: #3c2e1e;
  font-size: 18px;
  border-bottom: 2px solid #5a4a2f;
  padding-bottom: 8px;
}

.event-detail-modal p {
  margin: 8px 0;
  color: #4a3b28;
  line-height: 1.6;
  word-wrap: break-word;
  white-space: pre-wrap;
}

#modalDetail {
  max-height: 300px;
  overflow-y: auto;
  background: rgba(255, 255, 255, 0.7);
  padding: 10px;
  border: 2px solid #5a4a2f;
  margin-top: 10px;
  font-size: 13px;
}

.event-detail-modal .close-btn {
  position: absolute;
  top: 8px;
  right: 12px;
  background: #ff6b6b;
  color: white;
  border: 2px solid #5a4a2f;
  box-shadow: 2px 2px 0 #b9a782;
  padding: 4px 8px;
  cursor: pointer;
  font-family: 'MyCustomFont';
  font-size: 12px;
  font-weight: bold;
}

.life-event-tile {
  cursor: pointer;
  transition: transform 0.2s ease;
  position: relative;
  z-index: 15;
}

.life-event-tile:hover {
  transform: scale(1.05);
  z-index: 20;
}
.life-journey {
  position: relative;
}
.life-event {
  position: relative;
  z-index: 10;
}
.life-journey-line {
  z-index: 1;
  pointer-events: none;
}
.menu-left, .menu-right {
  display: flex;
  gap: 12px;
  align-items: center;
}

.menu-box {
  background-color: rgba(250, 235, 180, 0.9);
  background-image: url("{% static 'images/pixel-paper.png' %}");
  background-size: 4px 4px;
  background-repeat: repeat;
  border: 2.5px solid #5a4a2f;
  box-shadow: 3px 3px 0 #b9a782;
  padding: 6px 12px;
  font-weight: bold;
  color: #3c2e1e;
  font-size: 14px;
  text-decoration: none;
}

.menu-box.active {
  color: #007aff;
  font-weight: bold;
}

.top-nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 16px;
  margin-bottom: 20px;
}
.menu-box.active {
  color: #007aff;
  font-weight: bold;
}

.add-event-box {
  background-color: rgba(250, 235, 180, 0.95);
  background-image: url("{% static 'images/pixel-paper.png' %}");
  background-size: 8px 8px;
  background-repeat: repeat;
  border: 4px solid #2c1810;
  box-shadow: 6px 6px 0 #8b7355;
  border-radius: 0;
  padding: 20px;
  width: 400px;
  margin: 30px 0;
  font-family: 'MyCustomFont';
}

.add-event-title {
  margin: 0 auto 15px auto;
  color: #2c1810;
  font-size: 16px;
  font-family: 'MyCustomFont';
  text-align: center;
  background: #ffd700;
  border: 3px solid #2c1810;
  box-shadow: 3px 3px 0 #8b7355;
  padding: 8px 40px;
  width: 80%;
  cursor: pointer;
  border-radius: 0;
}

.error-message {
  background: #ffebee;
  border: 2px solid #f44336;
  color: #c62828;
  padding: 8px;
  font-size: 12px;
  font-family: 'MyCustomFont';
  border-radius: 4px;
  margin-top: 5px;
}

.add-event-form {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.event-input, .event-textarea {
  background: #ffffff;
  border: 3px solid #2c1810;
  box-shadow: inset 2px 2px 0 #e0e0e0;
  padding: 8px;
  font-family: 'MyCustomFont';
  font-size: 13px;
  color: #2c1810;
  border-radius: 0;
}

.event-submit-btn {
  background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);
  border: 4px solid #2c1810;
  box-shadow: 4px 4px 0 #8b7355, inset 1px 1px 0 #fff176;
  color: #2c1810;
  font-family: 'MyCustomFont';
  font-size: 16px;
  font-weight: bold;
  padding: 15px 30px;
  cursor: pointer;
  border-radius: 0;
  text-shadow: 1px 1px 0 #fff9c4;
  transition: all 0.1s ease;
}

.event-submit-btn:hover {
  background: linear-gradient(135deg, #ffb300 0%, #ff8f00 100%);
  transform: translate(1px, 1px);
  box-shadow: 3px 3px 0 #8b7355, inset 1px 1px 0 #fff176;
}

.error-message {
  background: #ffebee;
  border: 2px solid #f44336;
  color: #c62828;
  padding: 8px;
  font-size: 12px;
  font-family: 'MyCustomFont';
  border-radius: 4px;
  margin-top: 5px;
}

#reviewList {
  margin-top: 15px;
  max-height: 200px;
  overflow-y: auto;
}

#reviewList h4 {
  margin: 0 0 10px 0;
  color: #3c2e1e;
  border-bottom: 1px solid #5a4a2f;
  padding-bottom: 5px;
}

.policy-link {
  color: #007aff;
  text-decoration: none;
  font-weight: bold;
  border-bottom: 1px dotted #007aff;
}

.policy-link:hover {
  color: #005cbf;
  text-decoration: underline;
}
  </style>
</head>
<body>
 <div class="wrapper">
    <!-- 상단 네비게이션 -->
    <div class="top-nav">
      <div class="menu-left">

        <a href="{% url 'community:index' %}" class="menu-box home-link">
          <i class="fas fa-home"></i>
        <a href="{% url 'board:post_list' %}" 
   class="menu-box {% if request.resolver_match.url_name == 'post_list' %}active{% endif %}">커뮤니티</a>

<a href="{% url 'mentor:mentor_home' %}" 
   class="menu-box {% if request.resolver_match.url_name == 'mentor_home' %}active{% endif %}">멘토멘티</a>

<a href="{% url 'accounts:my_page' %}" 
   class="menu-box {% if request.resolver_match.url_name == 'my_page' %}active{% endif %}">마이페이지</a>

<a href="{% url 'youth_policy:basic_page' %}" 
   class="menu-box {% if request.resolver_match.url_name == 'basic_page' %}active{% endif %}">청년정책</a>

      </div>

    <div class="menu-right">      
    {% if user.is_authenticated %}
        <div class="login-info">{{ profile.nickname|default:user.username }}님 환영합니다</div>
    {% else %}
    
    <!-- <div class="login-info">{{user.username}}님 환영합니다</div> -->
    <a href="{% url 'accounts:login' %}" class="write-btn">로그인</a>
    {% endif %}
  </div>
    </div>
 
  <div class="main-wrapper">
    <div class="top-section">
      <div class="profile-box">
        <div class="profile-upper">
          <div class="left-profile">
            <div class="avatar-wrapper">
              {% if profile.avatar_image %}
                <img src="{{ profile.avatar_image.url }}" alt="아바타">
              {% elif profile.avatar_url %}
                <img src="{{ profile.avatar_url }}" alt="아바타">
              {% else %}
                <span>아바타 없음</span>
              {% endif %}
            </div>
            <div class="nickname-box">{{ profile.nickname|default:"닉네임 없음" }}</div>
          </div>
          <div class="right-profile">
            <div class="action-buttons">
              <a href="{% url 'mentor:mentor_request_direct' profile.id %}" style="text-decoration: none;"><button class="mentor-button">멘토링 신청</button></a>
              <button class="review-button" onclick="showReviewModal()">후기</button>
            </div>
            <div class="info-group">
              <div class="info-row"><div class="info-label">직업</div><div class="info-value">{{ profile.job|default:"없음" }}</div></div>
              <div class="info-row"><div class="info-label">나이</div><div class="info-value">{{ profile.age|default:"없음" }}</div></div>
              <div class="info-row"><div class="info-label">내공</div><div class="info-value">{{ profile.points|default:"00점" }}</div></div>
              <div class="info-row"><div class="info-label">관심</div><div class="info-value">{{ profile.interests|default:"-" }}</div></div>
              <div class="info-row"><div class="info-label">한줄 소개</div><div class="info-value">{{ profile.tagline|default:"-" }}</div></div>
            </div>
          </div>
      </div>
  {% if user == request.user %}
  <div class="edit-button-container">
    <a href="{% url 'accounts:profile_edit' %}">
      <button class="edit-button">수정하기</button>
    </a>
  </div>
  {% endif %}
</div>


      <div class="policy-box">
        <h3>📋 생애주기별 청년정책</h3>
        <div class="lifecycle-selector">
          <select id="lifecycleSelect" onchange="loadPoliciesByLifecycle()">
            <option value="">생애주기 선택</option>
            <option value="진로 탐색기">진로 탐색기</option>
            <option value="구직 준비기">구직 준비기</option>
            <option value="초기 취업기">초기 취업기</option>
            <option value="생활 기반 마련기">생활 기반 마련기</option>
            <option value="자기계발/이직기">자기계발/이직기</option>
            <option value="가족 형성기">가족 형성기</option>
          </select>
        </div>
        <div id="lifecycle-policies">
          <p>생애주기를 선택하면 관련 정책을 보여드립니다.</p>
        </div>
      </div>
      
  <div class="admin-extra-wrapper">
    <div class="admin-box">
      <h3>👩‍💼 관리자 추천</h3>
      <p style="font-size: 13px;">
        - 인생이 무엇인가? <a href="https://youth.seoul.go.kr/youthConts.do?key=2310200020&sc_pbancSeCd=013&sc_bbsStngSn=2212200001&sc_bbsCtgrySn=2310200012&sc_qnaCtgryCd=&sc_faqCtgryCd=008" target="_blank" class="policy-link">서울시 청년인생설계학교</a><br>
         <br>- 3년 저축, 최대 720만 원 추가 지원! <a href="https://www.bokjiro.go.kr/ssis-tbu/twataa/wlfareInfo/moveTWAT52011M.do?wlfareInfoId=WLF00000060" target="_blank" class="policy-link">청년내일저축계좌</a>
      </p>
    </div>

  </div>
</div>
<div class="board-section" style="background: radial-gradient(2px 2px at 20px 30px, #fff, transparent), radial-gradient(2px 2px at 40px 70px, #fff, transparent), radial-gradient(1px 1px at 90px 40px, #fff, transparent), radial-gradient(1px 1px at 130px 80px, #fff, transparent), radial-gradient(2px 2px at 160px 30px, #fff, transparent), radial-gradient(1px 1px at 200px 60px, #fff, transparent), radial-gradient(2px 2px at 240px 90px, #fff, transparent), radial-gradient(1px 1px at 280px 20px, #fff, transparent), radial-gradient(1px 1px at 320px 70px, #fff, transparent), radial-gradient(2px 2px at 360px 40px, #fff, transparent); background-repeat: repeat; background-size: 400px 100px; background-color: #1a1a2e;">
  <h2 class="section-title-box">인생여정</h2>
  <div class="life-journey-wrapper">
    <div class="life-journey smooth-line">
      {% for event in life_events %}
        <div class="life-event">
          <div class="life-event-tile" onclick="showEventDetail('{{ event.title }}', '{{ event.date }}', '{{ event.note|default:"" }}', '{{ event.detail|default:"" }}')" {% if user == request.user %}oncontextmenu="showDeleteMenu(event, {{ event.id }})"{% endif %}>
            <h4 class="life-event-title">{{ event.title }}</h4>
            <span class="life-event-date">{{ event.date }}</span>
            <div class="event-scores">
              <div class="score-item">
                <span class="score-label">💖 행복도</span>
                <div class="score-bar happiness-bar">
                  <div class="score-fill" style="width: {{ event.feeling|default:"0" }}%;"></div>
                  <span class="score-text">{{ event.feeling|default:"0" }}/100</span>
                </div>
              </div>
              <div class="score-item">
                <span class="score-label">🏆 성취도</span>
                <div class="score-bar achievement-bar">
                  <div class="score-fill" style="width: {{ event.score|default:"0" }}%;"></div>
                  <span class="score-text">{{ event.score|default:"0" }}/100</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
      <svg class="life-journey-line" xmlns="http://www.w3.org/2000/svg"></svg>
    </div>
  </div>
</div>

<!-- 이벤트 세부정보 모달 -->
<div class="modal-overlay" id="modalOverlay" onclick="hideEventDetail()"></div>
<div class="event-detail-modal" id="eventDetailModal">
  <button class="close-btn" onclick="hideEventDetail()">×</button>
  <h3 id="modalTitle"></h3>
  <p><strong>날짜:</strong> <span id="modalDate"></span></p>
  <p><strong>메모:</strong> <span id="modalNote"></span></p>
  <p><strong>상세 내용:</strong></p>
  <p id="modalDetail"></p>
</div>

<!-- 후기 모달 -->
<div class="modal-overlay" id="reviewModalOverlay" onclick="hideReviewModal()"></div>
<div class="event-detail-modal" id="reviewModal">
  <button class="close-btn" onclick="hideReviewModal()">×</button>
  <h3>후기 작성</h3>
  <form id="reviewForm" onsubmit="submitReview(event)">
    <input type="text" id="reviewNickname" value="{{ user.profile.nickname|default:user.username }}" class="event-input" readonly style="background: #f0f0f0;" />
    <textarea id="reviewContent" placeholder="후기 내용을 입력하세요" rows="4" class="event-textarea" required></textarea>
    <button type="submit" class="event-submit-btn">후기 등록</button>
  </form>
  <div id="reviewList">
    <h4>등록된 후기</h4>
    <div id="reviewItems"></div>
  </div>
</div>

<!-- 커스텀 우클릭 메뉴 -->
<div id="customMenu" class="custom-menu" style="display:none;">
  <form id="deleteForm" method="POST">
    {% csrf_token %}
    <button type="submit" class="delete-button">🗑️ 삭제하기</button>
  </form>
</div>

<!-- CSRF 토큰 -->
{% csrf_token %}

    {% if user == request.user %}
    <div class="add-event-box">
      <button type="submit" form="eventForm" class="add-event-title">➕ 새로운 인생 이벤트 추가하기</button>
      <form action="{% url 'accounts:add_life_event' %}" method="post" class="add-event-form" id="eventForm" onsubmit="return validateDateFormat()">
        {% csrf_token %}
        <input type="text" name="date" id="dateInput" placeholder="예: 25년 03월 21살" class="event-input" required />
        <div id="dateError" class="error-message" style="display: none;">💬 날짜를 00년 00월 00살 형식으로 적어주세요!</div>
        <input type="text" name="title" placeholder="이벤트 제목" class="event-input" required />
        <input type="text" name="note" placeholder="간단 메모" class="event-input" />
        <input type="text" name="feeling" placeholder="행복점수 (0-100)" class="event-input" />
        <input type="text" name="score" placeholder="성과점수 (0-100)" class="event-input" />
        <textarea name="detail" placeholder="상세 내용" rows="3" class="event-textarea"></textarea>

      </form>
    </div>
    {% endif %}
  </div>
  <script>
  document.addEventListener("click", function () {
    document.getElementById("customMenu").style.display = "none";
  });

  function showDeleteMenu(e, eventId) {
    e.preventDefault();
    const menu = document.getElementById("customMenu");
    menu.style.top = e.pageY + "px";
    menu.style.left = e.pageX + "px";
    menu.style.display = "block";
    const form = document.getElementById("deleteForm");
    form.action = `/accounts/life_event/delete/${eventId}/`;
  }

  function validateDateFormat() {
    const dateInput = document.getElementById('dateInput');
    const errorDiv = document.getElementById('dateError');
    const datePattern = /^\d{2}년 \d{1,2}월 \d{1,2}살$/;
    
    if (!datePattern.test(dateInput.value)) {
      errorDiv.style.display = 'block';
      dateInput.focus();
      return false;
    }
    errorDiv.style.display = 'none';
    return true;
  }
</script>
<script>
function showEventDetail(title, date, note, detail) {
  document.getElementById('modalTitle').innerText = title;
  document.getElementById('modalDate').innerText = date;
  document.getElementById('modalNote').innerText = note || '메모 없음';
  document.getElementById('modalDetail').innerText = detail || '상세 내용 없음';
  document.getElementById('modalOverlay').style.display = 'block';
  document.getElementById('eventDetailModal').style.display = 'block';
}

function hideEventDetail() {
  document.getElementById('modalOverlay').style.display = 'none';
  document.getElementById('eventDetailModal').style.display = 'none';
}

function showReviewModal() {
  document.getElementById('reviewModalOverlay').style.display = 'block';
  document.getElementById('reviewModal').style.display = 'block';
  loadReviews();
  checkUserReview();
}

function checkUserReview() {
  const currentUser = document.getElementById('reviewNickname').value;
  const reviews = JSON.parse(localStorage.getItem('reviews') || '[]');
  const hasReviewed = reviews.some(review => review.nickname === currentUser);
  
  const form = document.getElementById('reviewForm');
  if (hasReviewed) {
    form.style.display = 'none';
  } else {
    form.style.display = 'block';
  }
}

function hideReviewModal() {
  document.getElementById('reviewModalOverlay').style.display = 'none';
  document.getElementById('reviewModal').style.display = 'none';
}

function submitReview(event) {
  event.preventDefault();
  const nickname = document.getElementById('reviewNickname').value;
  const content = document.getElementById('reviewContent').value;
  
  const reviews = JSON.parse(localStorage.getItem('reviews') || '[]');
  const hasReviewed = reviews.some(review => review.nickname === nickname);
  
  if (hasReviewed) {
    alert('이미 후기를 작성하셨습니다.');
    return;
  }
  
  reviews.push({nickname, content, date: new Date().toISOString()});
  localStorage.setItem('reviews', JSON.stringify(reviews));
  
  document.getElementById('reviewForm').reset();
  loadReviews();
  checkUserReview();
}

function loadReviews() {
  const reviews = JSON.parse(localStorage.getItem('reviews') || '[]');
  const reviewItems = document.getElementById('reviewItems');
  const currentUser = document.getElementById('reviewNickname').value;
  reviewItems.innerHTML = '';
  
  reviews.forEach((review, index) => {
    const reviewItem = document.createElement('div');
    reviewItem.style.cssText = 'border: 2px solid #2c1810; padding: 8px; margin: 5px 0; background: rgba(255,255,255,0.8); position: relative;';
    
    let deleteButton = '';
    if (review.nickname === currentUser) {
      deleteButton = `<button onclick="deleteReview(${index})" style="position: absolute; right: 5px; top: 5px; background: #ff6b6b; color: white; border: 1px solid #2c1810; padding: 2px 6px; font-size: 10px; cursor: pointer;">삭제</button>`;
    }
    
    reviewItem.innerHTML = `<strong>${review.nickname}:</strong> ${review.content}${deleteButton}`;
    reviewItems.appendChild(reviewItem);
  });
}

function deleteReview(index) {
  const reviews = JSON.parse(localStorage.getItem('reviews') || '[]');
  reviews.splice(index, 1);
  localStorage.setItem('reviews', JSON.stringify(reviews));
  loadReviews();
  checkUserReview();
}



(function () {
  const svg = document.querySelector('.life-journey-line');
  const journey = document.querySelector('.life-journey');
  const events = document.querySelectorAll('.life-event');
  if (!svg || events.length < 2) return;

  const svgWidth = journey.scrollWidth;
  const svgHeight = journey.offsetHeight;
  svg.setAttribute('width', svgWidth);
  svg.setAttribute('height', svgHeight);
  svg.style.position = 'absolute';
  svg.style.top = '0';
  svg.style.left = '0';
  svg.innerHTML = '';

  const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  let d = '';

  const baseLeft = journey.getBoundingClientRect().left;
  const baseTop = journey.getBoundingClientRect().top;

  for (let i = 0; i < events.length - 1; i++) {
    const currRect = events[i].getBoundingClientRect();
    const nextRect = events[i + 1].getBoundingClientRect();

    const currX = currRect.left - baseLeft + currRect.width / 2;
    const currY = currRect.top - baseTop + currRect.height / 2;

    const nextX = nextRect.left - baseLeft + nextRect.width / 2;
    const nextY = nextRect.top - baseTop + nextRect.height / 2;

    if (i === 0) {
      d += `M ${currX},${currY} `;
    }

    const curveOffset = 40;
    const controlX1 = currX + curveOffset;
    const controlY1 = currY;
    const controlX2 = nextX - curveOffset;
    const controlY2 = nextY;

    d += `C ${controlX1},${controlY1} ${controlX2},${controlY2} ${nextX},${nextY} `;
  }

  path.setAttribute('d', d);
  path.setAttribute('fill', 'none');
  path.setAttribute('stroke', '#fff');
  path.setAttribute('stroke-width', '3');
  path.setAttribute('stroke-linecap', 'round');

  svg.appendChild(path);
})();

// 생애주기별 정책 로드
function loadPoliciesByLifecycle() {
  const lifecycle = document.getElementById('lifecycleSelect').value;
  const container = document.getElementById('lifecycle-policies');
  
  if (!lifecycle) {
    container.innerHTML = '<p>생애주기를 선택하면 관련 정책을 보여드립니다.</p>';
    return;
  }
  
  container.innerHTML = '<p>로딩 중...</p>';
  
  fetch(`/accounts/get-policies-by-lifecycle/?lifecycle=${encodeURIComponent(lifecycle)}`)
    .then(response => response.json())
    .then(data => {
      if (data.policies && data.policies.length > 0) {
        let html = '<ul>';
        data.policies.forEach(policy => {
          html += `<li><a href="/youth_policy/${policy.id}/" class="policy-link">${policy.name}</a></li>`;
        });
        html += '</ul>';
        container.innerHTML = html;
      } else {
        container.innerHTML = '<p>해당 생애주기에 맞는 정책이 없습니다.</p>';
      }
    })
    .catch(error => {
      console.error('Error:', error);
      container.innerHTML = '<p>정책을 불러오는 중 오류가 발생했습니다.</p>';
    });
}
</script>
</body>
</html>